{% extends 'admin/base.html' %}

{% block content %}
    <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-gray-300">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Order Management</h2>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {% for order in orders %}
                <div class="bg-gray-100 p-6 rounded-xl shadow-lg border-2 border-gray-400">
                    <div class="flex justify-between items-center mb-4">
                        <div class="font-semibold text-xl text-gray-800">
                            🛒 Order #{{ order.id }}
                        </div>
                        <div class="text-sm text-gray-600">
                            👤 Customer: <span class="font-semibold"><strong>{{ order.customer.user.username }} {{ order.customer.user.first_name }}</strong></span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <strong class="text-gray-700">📦 Products:</strong>
                            <ul class="list-disc pl-5 text-gray-800">
                                {% for item in order.order_items.all %}
                                    <li>{{ item.product.name }} - <span class="font-semibold">{{ item.quantity }}</span> units</li>
                                {% endfor %}
                            </ul>
                        </div>

                        <div>
                            <strong class="text-gray-700">💳 Payment Status:</strong>
                            {% if order.payment_status == 'Confirmed' %} 
                                <span class="px-3 py-1 inline-flex text-sm font-semibold rounded-full bg-green-200 text-green-800">
                                    ✅ Confirmed
                                </span>
                            {% else %}
                                <span class="px-3 py-1 inline-flex text-sm font-semibold rounded-full bg-red-200 text-red-800">
                                    ⚠️ Pending
                                </span>
                            {% endif %}
                            <strong>{{ order.total_price }} RWF</strong>
                            
                        </div>
                        <div class="bg-white shadow-md rounded-lg p-4 border border-gray-300">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">💰 Payment Proof:</h3>
                        
                            <div class="flex flex-wrap gap-3">
                                {% if order.payment_message %}
                                    <button 
                                        class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition duration-300 ease-in-out"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#paymentMessageModal-{{ order.id }}">
                                        📩 View Payment Message
                                    </button>
                                {% endif %}
                        
                                {% if order.payment_image %}
                                    <button 
                                        class="bg-green-500 text-white px-4 py-2 rounded-lg shadow hover:bg-green-600 transition duration-300 ease-in-out"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#paymentImageModal-{{ order.id }}">
                                        🖼️ View Payment Image
                                    </button>
                                {% endif %}
                                <a href="{% url 'order_detail' order.id %}" class="btn ">🔍 View Details</a>
                            </div>
                        
                            {% if not order.payment_message and not order.payment_image %}
                                <p class="text-gray-600 italic mt-2">⚠️ No payment proof provided.</p>
                                <a href="{% url 'order_detail' order.id %}" class="btn btn-primary">🔍 View Details</a>
                                <form action="{% url 'delete_order' order.id %}" method="post" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure?')">🗑️ Delete</button>
                                </form>
                            {% endif %}
                        </div>
                        
                    </div>

                    {% if order.payment_status == 'Pending' %}
                        <div class="mt-4">
                            <form method="post" action="{% url 'approve_payment' order.id %}">
                                {% csrf_token %}
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-300">
                                    ✅ Approve Payment
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </div>

                <!-- Payment Message Modal -->
                {% if order.payment_message %}
                <div class="modal fade" id="paymentMessageModal-{{ order.id }}" tabindex="-1" aria-labelledby="paymentMessageModalLabel-{{ order.id }}" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title text-gray-800" id="paymentMessageModalLabel-{{ order.id }}">
                                    💬 Payment Message for Order #{{ order.id }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-gray-700">{{ order.payment_message }}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Payment Image Modal -->
                {% if order.payment_image %}
                <div class="modal fade" id="paymentImageModal-{{ order.id }}" tabindex="-1" aria-labelledby="paymentImageModalLabel-{{ order.id }}" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title text-gray-800" id="paymentImageModalLabel-{{ order.id }}">
                                    🖼️ Payment Image for Order #{{ order.id }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <img src="{{ order.payment_image.url }}" alt="Payment Image" class="w-full rounded-lg shadow-lg">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

            {% endfor %}
        </div>
    </div>

    <!-- Include Bootstrap CSS and JavaScript (for Bootstrap 5) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
